
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4.5. Considerations for Clustering SNPs &#8212; Phenotype from Genotype</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. Discussion" href="7-discussion.html" />
    <link rel="prev" title="4.4. Preprocessing" href="4-preprocessing.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/thesis_logo_with_text.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Phenotype from Genotype</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Front Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../c0-front-matter/01-title-page.html">
   <code class="docutils literal notranslate">
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../c0-front-matter/02-declaration.html">
   Declaration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../c0-front-matter/03-abstract.html">
   Abstract
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../c0-front-matter/04-acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../c0-front-matter/05-full-table-of-contents.html">
   Table of Contents
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Background
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../c01-introduction/intro.html">
   1. Thesis style and philosophy
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c02-biology-background/0-index.html">
   2. How phenotype arises from genotype
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/1-big-questions.html">
     2.1. Big questions: What is genetically determined, and how?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/2-biological-molecules.html">
     2.2. Biological molecules: DNA, RNA, Proteins and the central dogma of molecular biology.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/3-more-dna.html">
     2.3. A closer look at DNA: Genomes, Genes, and Genetic Variation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/4-more-proteins.html">
     2.4. Looking more closely at proteins: function, structure and classification
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/5-phenotype.html">
     2.5. Phenotype
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c02-biology-background/6-summary.html">
     2.6. Summary: how genotype and phenotype are linked
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c03-compbio-background/0-index.html">
   3. How genotype and phenotype are measured and researched
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/1-sequencing-technology.html">
     3.1. Sequencing and microarrays
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/2-measuring-genotype-phenotype.html">
     3.2. From genotype to phenotype: what is measured
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/3-ontologies.html">
     3.3. Ontologies
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/4-comp-bio-methods.html">
     3.4. Predictive computational methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/5-bias.html">
     3.5. Sources of bias in computational biology
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/6-pqi.html">
     3.6. Proteome Quality Index
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c03-compbio-background/7-summary.html">
     3.7. Summary
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Phenotype prediction
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="0-index.html">
   4. Phenotype prediction with Snowflake
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="1-introduction.html">
     4.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="2-snowflake-algorithm.html">
     4.2.
     <code class="docutils literal notranslate">
      <span class="pre">
       Snowflake
      </span>
     </code>
     Algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="3-creating-inputs.html">
     4.3. Creating Snowflake inputs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="4-preprocessing.html">
     4.4. Preprocessing
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     4.5. Considerations for Clustering SNPs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="7-discussion.html">
     4.6. Discussion
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c05-alspac/0-index.html">
   5. Predicting phenotypes of the ALSPAC cohort using Snowflake
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c05-alspac/1-introduction.html">
     5.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c05-alspac/5-discussion.html">
     5.2. Discussion
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tissue-specific gene expression
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c06-filter/0-index.html">
   6. Filtering computational predictions with tissue-specific expression information
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/1-introduction.html">
     6.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/2-algorithm.html">
     6.2. Algorithm
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/3-data.html">
     6.3. Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/5-methods.html">
     6.4. Validation method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/6-results.html">
     6.5. Filip results
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c06-filter/7-discussion.html">
     6.6. Discussion and Future work
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c07-ontolopy/0-index.html">
   7. Ontolopy
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/1-introduction.html">
     7.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/2-functionality.html">
     7.2. Functionality
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/3-how-it-works.html">
     7.3. Ontolopy tools and practices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/4-misc-examples.html">
     7.4. Example uses: mapping samples to diseases or phenotypes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/5-mapping-example.html">
     7.5. Example use: mapping samples to tissue-related phenotypes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/6-discussion.html">
     7.6. Discussion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c07-ontolopy/7-future-work.html">
     7.7. Future Work
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../c08-combining/0-index.html">
   8. Combining RNA-seq datasets
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../c08-combining/1-background.html">
     8.1. Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c08-combining/2-data.html">
     8.2. Data Acquisition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c08-combining/3-data-wrangling.html">
     8.3. Data Wrangling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../c08-combining/7-discussion.html">
     8.4. Results and discussion
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Concluding remarks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../c09-conclusion/0-conclusion.html">
   9. Concluding remarks
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  End Matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../cz-end-matter/0-appendix.html">
   Appendix
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cz-end-matter/reference.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#combinations-of-snps">
   4.5.1. Combinations of SNPs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#choice-of-clustering-methodology">
   4.5.2. Choice of clustering methodology
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#choice-of-distance-metric">
     4.5.2.1. Choice of distance metric
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="considerations-for-clustering-snps">
<span id="clustering-snps"></span><h1><span class="section-number">4.5. </span>Considerations for Clustering SNPs<a class="headerlink" href="#considerations-for-clustering-snps" title="Permalink to this headline">¶</a></h1>
<p>In this section, I discuss the implementation of clustering and outlier detection methodologies for SNPs.</p>
<p>Snowflake is essentially a method for finding unusual combinations of SNPs, within sets of SNPs associated with a phenotype.
Since there will be many rare combinations of SNPs just through randomness, the deleteriousness score (via FATHMM) decides which rare combinations are of interest.</p>
<p>The clustering takes place per phenotype, with the distinct phenotypes and the SNPs associated with them are chosen according to dcGO.
This therefore determines how many dimensions (SNPs) we are clustering on for any given phenotype</p>
<!--
Put this back in if I can get to it
## Cases to test

While `snowflake` was created to find complex traits (featuring combinations of SNPs), we would also like it to work for single SNPs.
Data is simulated for the following cases, representing the diversity of phenotypes that `snowflake` should predict phenotypes for:
- 1 dominant (high-scoring) SNP with a rare allele
- 2 dominant SNPs with a rare combination of alleles
- 3 dominant SNPs with a rare combination of alleles
- 5 dominant SNPs with a rare combination of alleles
- 10 dominant SNPs with a rare combination of alleles
-->
<div class="section" id="combinations-of-snps">
<span id="id1"></span><h2><span class="section-number">4.5.1. </span>Combinations of SNPs<a class="headerlink" href="#combinations-of-snps" title="Permalink to this headline">¶</a></h2>
<p>Given <span class="math notranslate nohighlight">\(N\)</span> SNPs of interest, there are <span class="math notranslate nohighlight">\(3^N\)</span> different options for individual’s combinations of calls for biallelic SNPS, since there are three different options for each SNP <code class="docutils literal notranslate"><span class="pre">WW</span></code> wild-wild homozygous, <code class="docutils literal notranslate"><span class="pre">MW</span></code>/<code class="docutils literal notranslate"><span class="pre">WM</span></code> heterozygous, or <code class="docutils literal notranslate"><span class="pre">MM</span></code> mutant-mutant heterozygous.</p>
<!--{numref}`snp-combo-table` shows this for 2 SNPs.-->
<p>For our purposes, heterozygous SNPs are considered the same whether they are mutant-wild <code class="docutils literal notranslate"><span class="pre">MW</span></code> or wild-mutant <code class="docutils literal notranslate"><span class="pre">WM</span></code>, since we assume they would create the same balance of proteins in a cell.</p>
<!--
```{list-table} Table showing all possible combinations of calls for two biallelic SNPs where M denotes mutant type and W denotes wild type.
:header-rows: 1
:name: snp-combo-table

* - count
  - SNP 1
  - SNP 2
* - 1
  - `WW`
  - `WW`
* - 2
  - `WW`
  - `WM`
* - 3
  - `WW`
  - `MM`
* - 4
  - `WM`
  - `WW`
* - 5
  - `WM`
  - `WM`  
* - 6
  - `WM`
  - `MM`
* - 7
  - `MM`
  - `WW`
* - 8
  - `MM`
  - `WM`  
* - 9
  - `MM`
  - `MM`
````
-->
<div class="note admonition" id="linkage-disequilibrium">
<p class="admonition-title">Linkage Disequilibrium</p>
<p>Linkage disequilibrium is the measure of how much more often alleles are found together than would be expected if they were randomly distributed.
SNPs are not independent, and we wouldn’t expect alleles to be randomly distributed for many reasons, for example because:</p>
<ul class="simple">
<li><p>SNPs are inherited together through genetic linkage, due to being on the same gene or nearby genes from one another.</p></li>
<li><p>we would expect combinations of SNPs to reflect the structure of the population, e.g. individuals who are geographically close to one another are more likely to have similar genetics.</p></li>
<li><p>particular combinations of SNPs may be fatal or otherwise prevent people from passing them on.</p></li>
</ul>
</div>
<p>The combinations of SNPs are not distributed randomly based only on the frequency of each SNP independently, this is what’s known in population genetics as <a class="reference internal" href="#linkage-disequilibrium"><span class="std std-ref">linkage disequilibrium</span></a>.</p>
<!--
Given any 2 or 3 random SNPs, much of the combinatorial space is empty, as {numref}`empty-combinatorial-space` shows.

[//]: # (TODO: Make empty-combinatorial-space image, possibly also show a table showing where this data comes from - actually shows empty space - explain that it does also show there are random combinations - like these things aren't zero, they're just rarer than you would expect)

[//]: # (TODO: Calculate mean and sd of mm/mw/ww)

[//]: # (TODO: Explain that heterozygous SNPs can also be disease-causing and that sometimes we will be looking to score highly just homozygous people and sometimes homo and heterozygous people. Give examples from SNPedia. Maybe move this to overview?)

```{code-cell} ipython3
import allel

vcf = allel.read_vcf('data/alspac_hg19_allSNPs_header.vcf', fields=['variants/*', 'samples', 'calldata/GT'])

# TODO: Allel isn't workig to read in vcf... do it like I did before and remove allel from requirements
```

## Simulating SNP data
In order to test how well the clustering methods worked, I simulated data with a rare combination of mid-high scoring SNPs, representing the ideal candidates for detection by `snowflake`.

[//]: # (TODO: add detail of generation of genotypes, step 1)

1. Randomly generate genotypes for 300 SNPs and 2500 individuals.
2. Randomly generate SNP deleteriousness scores for 300 SNPs.
3. For 10 high-scoring SNPs, ensure that all individuals have exist in subpopulations.

```{code-cell} ipython3
import numpy as np

num_individuals = 1000

num_important_snps = [1, 2, 3, 5, 10]  # med-high score AND rare *combination*
num_snps_iter = range(2,100) # snps involved with phenotype

# TODO: first try with only important snps high scoring, then try with some unimportant snps (not rare) high scoring
# TODO: Simulating the data is difficult because of the combinatoric nature of the snps. Test for whether similar combinatorics are happening, for 2 medium-scoring snps within a phenotype.

def simulate_data(num_important_snps, num_snps, num_with_phenotype):
    """Simulate SNP data"""
    with_phenotype = np.random.randint(1,num_individuals, num_with_phenotype)
    snps_causing_phenotype = np.random.randint(1, num_snps, num_important_snps)
    
    # Simulate deleteriousness scores per snp... 
    # TODO: Simulate deleteriousness scores separately outside simulate_data
    deleteriousness_scores = [np.random.random() for i in num_snps]  # TODO: draw from actual distribution of scores 
    # TODO: Also increase the deleteriousness for some other common snps
    for i in snps_causing_phenotype:
        deleteriousness_scores[i] *= 5 
    
    # Simulate rarity of calls per snp, normally distributed percentage in biggest category
    # TODO: check distribution % homozygous, more common hetero, less common hetero
    rarity = []
    for i in range(num_snps):
        homo = np.random.normal(proportion_homozygous_mean, proportion_homozygous_sd)
        hetero_common = np.random.normal(proportion_homozygous_mean, proportion_homozygous_sd)
        # three options MM, MW (same as WM), and WW.
        
    # TODO: run it through the actual snowflake create_distance_matrix
    data = np.zeroes(num_snps, num_individuals)
    for i in range(num_snps):
        # TODO implement for different distance metrics
        
    
        
    return data
```

```{code-cell} ipython3
import numpy as np
import scipy.stats as stats

num_individuals = 2500

print(np.random.randint(1,num_individuals, 5))
```

```{code-cell} ipython3
num_snps = 10

# TODO: See if normally distributed is the best distribution for this
# TODO: Make this into a `simulate_genotypes` function.
# TODO: Might want to do this for less common rather than more common.
# TODO: Probably just want to do this once, not inside the simulate_data function

def simulate_genotypes(num_snps, num_individuals, homo_mean=0.7, homo_sd=0.5, hetc_mean=0, hetc_sd=0.001):
    """
    homo_mean: mean proportion of homozygous calls
    homo_sd: standard deviation of homozygous calls
    hetc_mean: mean proportion of most common heterozygous calls
    hetc_sd: standard deviation of most common heterozygous calls
    """
    lower, upper = 0, 1  # bounds

    homo = stats.truncnorm((lower - homo_mean)/homo_sd, (upper - homo_mean)/homo_sd, homo_mean, homo_sd).rvs(num_snps)
    hetero_common = stats.truncnorm((lower - hetc_mean)/hetc_sd, (upper - hetc_mean)/hetc_sd, hetc_mean, hetc_sd).rvs(num_snps)

    # Fix invalid proportions (add up to greater than 100%)
    invalid = homo + hetero_common > 1
    while sum(invalid) != 0:
        # Make replacements
        homo_r = stats.truncnorm((lower - homo_mean)/homo_sd, (upper - homo_mean)/homo_sd, homo_mean, homo_sd).rvs(sum(invalid))
        hetero_common_r = stats.truncnorm((lower - hetc_mean)/hetc_sd, (upper - hetc_mean)/hetc_sd, hetc_mean, hetc_sd).rvs(sum(invalid))

        # For every valid replacement, replace:
        r = 0  # replacement_count
        for i, valid in enumerate(homo_r + hetero_common_r < 1):
            if valid:
                homo[np.where(invalid==True)[0][r]] = homo_r[i]
                hetero_common[np.where(invalid==True)[0][r]] = hetero_common_r[i]
                r+=1
        assert(sum(homo + hetero_common > 1) <= sum(invalid))
        invalid = homo + hetero_common > 1    

    rarity = np.zeros((num_snps, 3))
    for i in range(num_snps):
        rarity[i] = [
            int(np.round(num_individuals*homo[i])), 
            int(np.round(num_individuals*hetero_common[i])), 
            int(np.round(num_individuals*(1 - homo[i] - hetero_common[i])))
        ]
    rarity = rarity.astype(int)
    print(rarity)
    return None
    
simulate_genotypes(1000, num_individuals)
[//]: # (TODO: Turn into np array like we have internally when we read in the VCF)
```

```{code-cell} ipython3
[//]: # (TODO: OPTIONAL: Number of call combinations seen per random pairs/trios of SNPs - different for SNPs in the same pathway/phenotype/similar domains?)
```

### The specificity of phenotypes
[//]: # (TODO: Write: show example of a DcGO "phenotype" with a weird combinations of phenotype terms.)

+++
-->
</div>
<div class="section" id="choice-of-clustering-methodology">
<span id="clustering-methodology"></span><h2><span class="section-number">4.5.2. </span>Choice of clustering methodology<a class="headerlink" href="#choice-of-clustering-methodology" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="non-spherical">
<a class="reference internal image-reference" href="../_images/clustering_snps.png"><img alt="../_images/clustering_snps.png" src="../_images/clustering_snps.png" style="height: 220px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4.7 </span><span class="caption-text">A drawing indicating how the combinations of SNPs we might expect to cause disease would represent a non spherical relationship between SNPs.</span><a class="headerlink" href="#non-spherical" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="clustering-comparison">
<a class="reference internal image-reference" href="../_images/clustering_comparison.png"><img alt="../_images/clustering_comparison.png" src="../_images/clustering_comparison.png" style="height: 220px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4.8 </span><span class="caption-text">Comparison illustrating differences between the implemented clustering methods. Image adapted from sklearn documentation<span id="id2">[<a class="reference internal" href="../cz-end-matter/reference.html#id127"><span>181</span></a>]</span>.</span><a class="headerlink" href="#clustering-comparison" title="Permalink to this image">¶</a></p>
</div>
<p>The original implementation of the phenotype predictor used k-means clustering<span id="id3">[<a class="reference internal" href="../cz-end-matter/reference.html#id126"><span>182</span></a>]</span>.
This wasn’t suitable for the predictor, since we expect combinations of SNPs to form non-spherical shapes (see <a class="reference internal" href="#non-spherical"><span class="std std-numref">Fig. 4.7</span></a>), and k-means cannot achieve this (see <a class="reference internal" href="#clustering-comparison"><span class="std std-numref">Fig. 4.8</span></a>).</p>
<p>Spectral clustering, DBSCAN (Density-Based Spatial Clustering of Applications with Noise), IDOS, OPTICS and LOF (Local Outlier Factor) were also implemented.
This involved automation of parameter selection, to enable clustering to be performed automatically on thousands of phenotype terms.
These methods have theoretical pros and cons with respect to the predictor.
For example, OPTICS and DBSCAN do not need the number of clusters as an input, but instead require the minimum number of points required to form a cluster and a radius from each point to consider as part of a cluster, which has more meaning in this context.
They also automatically output outliers to clusters, which will affect the resulting phenotype score, potentially in unseen ways - particularly as it is difficult to visualise high-dimensional data. OPTICS is the default setting, as in addition to not requiring a number of clusters, it can identify clusters of differing densities (a quality that DBSCAN lacks - as can be seen in the second row of <a class="reference internal" href="#clustering-comparison"><span class="std std-numref">Fig. 4.8</span></a>).
A final informed choice between these options requires a large benchmarking set.</p>
<div class="section" id="choice-of-distance-metric">
<span id="distance-metric"></span><h3><span class="section-number">4.5.2.1. </span>Choice of distance metric<a class="headerlink" href="#choice-of-distance-metric" title="Permalink to this headline">¶</a></h3>
<p>The phenotype predictor’s original distance metric was non-linear, such that the homozygous calls were further from each other than the distance via the heterozygous call, as shown in <a class="reference internal" href="#non-linear-metric"><span class="std std-numref">Fig. 4.9</span></a>.
Non-linear distance metrics mean that it is not possible to create a location matrix rather than a distance matrix.
This is required for some types of clustering.</p>
<p>A linear distance metric which also captured the increased likelihood of homozygous alleles to be disease-causing (<a class="reference internal" href="#linear-metric"><span class="std std-numref">Fig. 4.10</span></a>) was developed to enable this, and to better represent the biology.
In this version, the popularity of an allele decides which homozygous call the heterozygous call is more functionally similar to.</p>
<div class="figure align-default" id="non-linear-metric">
<a class="reference internal image-reference" href="../_images/nonlinear_metric.png"><img alt="../_images/nonlinear_metric.png" src="../_images/nonlinear_metric.png" style="width: 220px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4.9 </span><span class="caption-text">Original non-linear distance metric.
<span class="math notranslate nohighlight">\(MM\)</span> denotes homozygous mutant alleles, <span class="math notranslate nohighlight">\(WW\)</span> denotes homozygous wild type alleles, and <span class="math notranslate nohighlight">\(MW\)</span> denotes heterozygous alleles.
The FATHMM score for the SNP <span class="math notranslate nohighlight">\(f\)</span>, defines the distance between the wild type and mutant alleles.</span><a class="headerlink" href="#non-linear-metric" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="linear-metric">
<a class="reference internal image-reference" href="../_images/linear_metric.png"><img alt="../_images/linear_metric.png" src="../_images/linear_metric.png" style="width: 220px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4.10 </span><span class="caption-text">Linear distance metrics. <span class="math notranslate nohighlight">\(MM\)</span> denotes homozygous mutant alleles, <span class="math notranslate nohighlight">\(WW\)</span> denotes homozygous wild type alleles, and <span class="math notranslate nohighlight">\(MW\)</span> denotes heterozygous alleles, and <span class="math notranslate nohighlight">\(N\)</span> represents the number of people with that allele call. The FATHMM score for the SNP <span class="math notranslate nohighlight">\(f\)</span>, defines the distance between the wild type and mutant alleles.</span><a class="headerlink" href="#linear-metric" title="Permalink to this image">¶</a></p>
</div>
<!--
### Input individuals
[//]: # (TODO: Sensitivity of clustering score to background cohort)
--><!--
### Overcoming the curse of dimensionality in Snowflake
-->
<!--
#### Dimensionality reduction
[//]: # (TODO: When is dimensionality reduction appropriate? Correlation between SNPs, cooccurance of snps, FATHMM scores, Too many SNPs for a phenotype.)

#### Sensitivity of number of SNPs on final score
[//]: # (TODO: Show the effect of number of SNPs per phenotypes on the sensitivity of the final score to the FATHMM score. Choose a phenotype with many snps and randomly sample various numbers of them and see the how sensitive the results are.)

#### Sensitivity of particular SNPs on final score
[//]: # (TODO: Randomly delete SNPs and see how this effects the final score)
[//]: # (TODO: See how number of SNPs and randomly deleting them interacts)
[//]: # (TODO: Explain meaningfulness, show DcGO prediction, where SNP is in a gene which is not expressed in the tissue)
-->
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./c04-snowflake"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="4-preprocessing.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title"><span class="section-number">4.4. </span>Preprocessing</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="7-discussion.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title"><span class="section-number">4.6. </span>Discussion</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Natalie Thurlby<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>